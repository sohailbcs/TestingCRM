<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<!-- Include Toastr CSS and JS, jQuery, FontAwesome, and SheetJS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script> <!-- Add this for SheetJS -->
<div class="content-wrapper">
    <div class="content-wrapper-before"></div>
    <div class="container-full">

        @if (TempData["SuccessMessage"] != null)
        {
            <script>
                // Display the success message as a popup alert
                $(document).ready(function () {
                    alert('@TempData["SuccessMessage"]');
                });
            </script>
        }
        <!-- Main content -->
        <section class="content">
            <!-- Content Header (Page header) -->
            <div class="content-header">
                <div class="d-flex align-items-center">
                    <div class="w-p100 d-md-flex align-items-center justify-content-between">
                        <h3 class="page-title">   </h3>
                        <div class="d-inline-block align-items-center">
                            <nav>
                                <ol class="breadcrumb">
                                </ol>
                            </nav>
                        </div>
                    </div>

                </div>
            </div>
            <div class="row">

                <div class="col-12">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">Universities Summary</h3>
                            <div class="float-right">

                                <div class="mb-3 d-flex justify-content-end">
                                    <a class="btn float-end btn-primary" href="/Admin/University/AddUniversity">
                                        <i class="bi bi-plus-circle"></i>&nbsp;Add University
                                    </a>
                                </div>
                                <!-- Add Export Button -->
                                <div class="mb-3 d-flex justify-content-end">
                                    <button id="exportBtn" class="btn btn-success">
                                        <i class="fa fa-download"></i> Export to Excel
                                    </button>
                                </div>
                            </div>
                        </div>



                        <!-- /.box-header -->
                        <div class="box-body">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Search Filters</h5>
                                </div>
                                <div class="card-body">
                                    <form id="filterForm">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="firstNameFilter">Name</label>
                                                    <input type="text" class="form-control" id="firstNameFilter" placeholder="Name" />
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="sourceFilter">Website</label>
                                                    <input type="text" class="form-control" id="sourceFilter" placeholder="Website" />
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="phoneFilter">Contact Number</label>
                                                    <input type="text" class="form-control" id="phoneFilter" placeholder="Phone Number" />
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="emailFilter">Email</label>
                                                    <input type="text" class="form-control" id="emailFilter" placeholder="Email" />
                                                </div>
                                            </div>


                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="sourceFilter">Country</label>
                                                    <input type="text" class="form-control" id="BranchFilter" placeholder="Country" />
                                                </div>
                                            </div>




                                        </div>

                                    </form>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table id="brandTable" class="display expandable-table" style="width:100%">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th style="background-color: #4e0973;color:white;">Name</th>
                                            <th style="background-color: #4e0973;color:white;">Website</th>
                                            <th style="background-color: #4e0973;color:white;">Contact Number</th>
                                            <th style="background-color: #4e0973;color:white;">Email</th>
                                            <th style="background-color: #4e0973;color:white;">Country</th>
                                            <th style="background-color: #4e0973;color:white;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- /.box-body -->
                    </div>
                </div>
            </div>

        </section>

    </div>
</div>

@* <div class="main-panel">
    @if (TempData["SuccessMessage"] != null)
    {
        <script>
            // Display the success message as a popup alert
            $(document).ready(function () {
                alert('@TempData["SuccessMessage"]');
            });
        </script>
    }
    <div class="content-wrapper">
        <div class="row">
            <div class="col-md-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <p class="card-title"> Universities</p>
                        <div class="row">
                            <div class="col-12">
                                <div class="row">
                                    <div class="col-md-6">
                                        <a class="btn float-end btn-primary" href="/Admin/University/AddUniversity">
                                            <i class="bi bi-plus-circle"></i>&nbsp;Add University
                                        </a>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table id="brandTable" class="display expandable-table" style="width:100%">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th scope="col">Name</th>
                                                <th scope="col">Website</th>
                                                <th scope="col">Contact Number</th>
                                                <th scope="col">Email</th>
                                                <th scope="col">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> *@
<!-- Edit University Modal -->

<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

@section Scripts {
    <script>
        $(document).ready(function () {
            var table = $('#brandTable').DataTable({
                "ajax": {
                    "url": "/Admin/University/GetUniversity",
                    "type": "GET",
                    "datatype": "json"

                },
                "columns": [
                    { "data": "name", "autoWidth": true },
                    {
                        "data": "website",
                        "autoWidth": true,
                        "render": function (data, type, row) {
                            if (type === 'display') {
                                return '<a href="' + data + '" target="_blank">' + data + '</a>';
                            }
                            return data;
                        }
                    },
                    { "data": "contactPhone", "autoWidth": true },
                    { "data": "contactEmail", "autoWidth": true },
                    { "data": "country", "autoWidth": true },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            var editButton = '<a href="#" class="btn btn-primary open-modal me-3" ' +
                                'data-universityid="' + row.universityId + '" ' +
                                'data-name="' + row.name + '" ' +
                                'data-website="' + (row.website || '') + '" ' +
                                'data-contactphone="' + (row.contactPhone || '') + '" ' +
                                'data-contactemail="' + (row.contactEmail || '') + '" ' +
                                'data-streetaddress="' + (row.streetAddress || '') + '" ' +
                                'data-country="' + (row.country || '') + '" ' +
                                'data-founded="' + (row.founded || '') + '" ' +
                                'data-chancellor="' + (row.chancellor || '') + '" ' +
                                'data-ranking="' + (row.ranking || '') + '" ' +
                                'style="padding: 12px; margin-right: 5px;">' +
                                '<i class="bi bi-pencil" style="margin-right: 5px;"></i>   </a>';

                            var deleteButton = '<a href="#" class="btn btn-danger delete-btn" ' +
                                'data-universityid="' + row.universityId + '" ' +
                                'style="padding: 12px; margin-right: 5px;">' +
                                '<i class="bi bi-trash" style="margin-right: 3px;"></i>   </a>';

                            return editButton + deleteButton;
                        }
                    }
                ]
            });

            // Filter by First Name
            $('#firstNameFilter').on('keyup', function () {
                table.column(0).search(this.value).draw();
            });
            // Filter by Source
            $('#sourceFilter').on('keyup', function () {
                table.column(1).search(this.value).draw();
            });

            // Filter by Phone Number
            $('#phoneFilter').on('keyup', function () {
                table.column(2).search(this.value).draw();
            });
            // Filter by Email
            $('#emailFilter').on('keyup', function () {
                table.column(3).search(this.value).draw();
            });
            // Filter by Source
            $('#BranchFilter').on('keyup', function () {
                table.column(4).search(this.value).draw();
            });


            $('.dataTables_length').hide(); // Hide the 'Show entries' dropdown

            // Open edit modal on edit button click
            $('#brandTable').on('click', '.open-modal', function () {
                var universityId = $(this).data('universityid');
                var name = $(this).data('name');
                var website = $(this).data('website');
                var contactPhone = $(this).data('contactphone');
                var contactEmail = $(this).data('contactemail');
                var streetAddress = $(this).data('streetaddress');
                var country = $(this).data('country');
                var founded = $(this).data('founded');
                var chancellor = $(this).data('chancellor');
                var ranking = $(this).data('ranking');

                // Populate modal fields
                $('#editUniversityId').val(universityId);
                $('#editUniversityName').val(name);
                $('#editUniversityWebsite').val(website);
                $('#editUniversityContactPhone').val(contactPhone);
                $('#editUniversityContactEmail').val(contactEmail);
                $('#editUniversityStreetAddress').val(streetAddress);
                $('#editUniversityCountry').val(country);
                $('#editUniversityFounded').val(founded);
                $('#editUniversityChancellor').val(chancellor);
                $('#editUniversityRanking').val(ranking);

                // Show the modal
                $('#editUniversityModal').modal('show');
            });

            $('#editUniversityButton').on('click', function () {
                var isValid = true;

                // Clear previous errors
                $('.text-danger').hide();

                // Validate university name
                var name = $('#editUniversityName').val();
                if (name.length < 3) {
                    $('#nameError').text('Minimum length is 3 characters.').show();
                    isValid = false;
                } else if (name.length > 20) {
                    $('#nameError').text('Maximum length is 20 characters.').show();
                    isValid = false;
                } else if (/\d/.test(name)) {
                    $('#nameError').text('Numbers are not allowed.').show();
                    isValid = false;
                }

                // Validate country
                var country = $('#editUniversityCountry').val();
                if (country.length < 3) {
                    $('#countryError').text('Minimum length is 3 characters.').show();
                    isValid = false;
                } else if (country.length > 20) {
                    $('#countryError').text('Maximum length is 20 characters.').show();
                    isValid = false;
                } else if (/\d/.test(country)) {
                    $('#countryError').text('Numbers are not allowed.').show();
                    isValid = false;
                }

                // Validate URL
                var website = $('#editUniversityWebsite').val();
                var urlPattern = /^(https?:\/\/)?([^\s$.?#].[^\s]*)$/i;
                if (website && !urlPattern.test(website)) {
                    $('#websiteError').text('Please enter a valid website URL.').show();
                    isValid = false;
                }

                // Validate address
                var address = $('#editUniversityStreetAddress').val();
                if (address.length < 3) {
                    $('#addressError').text('Minimum length is 3 characters.').show();
                    isValid = false;
                } else if (address.length > 200) {
                    $('#addressError').text('Maximum length is 200 characters.').show();
                    isValid = false;
                } else if (/\d/.test(address)) {
                    $('#addressError').text('Numbers are not allowed.').show();
                    isValid = false;
                }
                // Validate email
                var email = $('#editUniversityContactEmail').val();
                var emailPattern = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                if (email && !emailPattern.test(email)) {
                    $('#emailError').text('Please enter a valid email address.').show();
                    isValid = false;
                }

                // Validate contact number
                var number = $('#editUniversityContactPhone').val();
                if (number.length < 11) {
                    $('#phoneError').text('Minimum length is 11 characters.').show();
                    isValid = false;
                } else if (/[a-zA-Z]/.test(number)) {
                    $('#phoneError').text('Alphabets are not allowed.').show();
                    isValid = false;
                }

                // If validation fails, stop form submission
                if (!isValid) {
                    return;
                }

                var universityId = $('#editUniversityId').val();
                var data = {
                    UniversityId: universityId,
                    Name: name,
                    Website: website,
                    ContactPhone: number,
                    ContactEmail: email,
                    StreetAddress: address,
                    StreetAddress: $('#editUniversityStreetAddress').val(),
                    Country: country,
                    Founded: $('#editUniversityFounded').val(),
                    Chancellor: $('#editUniversityChancellor').val(),
                    Ranking: $('#editUniversityRanking').val()
                };

                $.ajax({
                    url: '/Admin/University/EditUni',
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        console.log('Server response:', response);

                        if (response.success) {
                            $('#editUniversityModal').modal('hide');
                            alert(response.message);
                            table.ajax.reload(); // Reload DataTable after successful update
                        } else {
                            alert('Failed to update university: ' + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error updating university:', error);
                        alert('Error updating university. Please try again.');
                    }
                });
            });

            // Handle delete button click
            $('#brandTable').on('click', '.delete-btn', function () {
                var universityId = $(this).data('universityid'); // Assuming data-universityid attribute contains universityId

                if (confirm('Are you sure you want to delete this university?')) {
                    $.ajax({
                        url: '/Admin/University/DeleteUniversity', // Replace with your controller action URL for deleting
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ universityId: universityId }), // Send universityId as JSON payload
                        success: function (response) {
                            console.log('Server response:', response);

                            if (response.success) {
                                alert(response.message);
                                table.ajax.reload();
                            } else {
                                alert('Failed to delete university: ' + response.message);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error deleting university:', error);
                            alert('Error deleting university. Please try again.');
                        }
                    });
                }
            });

            // Add validation for each field in the modal on blur
            $('#editUniversityName').on('blur', function () {
                var name = $(this).val();
                var errorMessage = '';

                if (name.length < 3) {
                    errorMessage = 'Minimum length is 3 characters.';
                } else if (name.length > 20) {
                    errorMessage = 'Maximum length is 20 characters.';
                } else if (/\d/.test(name)) {
                    errorMessage = 'Numbers are not allowed.';
                }

                if (errorMessage) {
                    $('#nameError').text(errorMessage).show();
                } else {
                    $('#nameError').hide();
                }
            });

            $('#editUniversityCountry').on('blur', function () {
                var country = $(this).val();
                var errorMessage = '';

                if (country.length < 3) {
                    errorMessage = 'Minimum length is 3 characters.';
                } else if (country.length > 20) {
                    errorMessage = 'Maximum length is 20 characters.';
                } else if (/\d/.test(country)) {
                    errorMessage = 'Numbers are not allowed.';
                }

                if (errorMessage) {
                    $('#countryError').text(errorMessage).show();
                } else {
                    $('#countryError').hide();
                }
            });

            $('#editUniversityWebsite').on('blur', function () {
                var website = $(this).val();
                var urlPattern = /^(https?:\/\/)?([^\s$.?#].[^\s]*)$/i;
                if (website && !urlPattern.test(website)) {
                    $('#websiteError').text('Please enter a valid website URL.').show();
                } else {
                    $('#websiteError').hide();
                }
            });

            $('#editUniversityContactEmail').on('blur', function () {
                var email = $(this).val();
                var emailPattern = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                if (email && !emailPattern.test(email)) {
                    $('#emailError').text('Please enter a valid email address.').show();
                } else {
                    $('#emailError').hide();
                }
            });

            $('#editUniversityContactPhone').on('blur', function () {
                var number = $(this).val();
                var errorMessage = '';

                if (number.length < 11) {
                    errorMessage = 'Minimum length is 11 characters.';
                } else if (/[a-zA-Z]/.test(number)) {
                    errorMessage = 'Alphabets are not allowed.';
                }

                if (errorMessage) {
                    $('#phoneError').text(errorMessage).show();
                } else {
                    $('#phoneError').hide();
                }
            });

            // Export table to Excel (first 5 columns)
            $('#exportBtn').click(function () {
                var tableData = [];
                var headers = ['Name', 'Website',  'Contact Number', 'Email', 'Country'];

                // Extract first 6 columns
                $('#brandTable thead tr th').each(function (index) {
                    if (index < 5) {
                        headers.push($(this).text());
                    }
                });

                tableData.push(headers);

                // Extract data from each row
                $('#brandTable tbody tr').each(function () {
                    var rowData = [];
                    $(this).find('td').each(function (index) {
                        if (index < 5) {
                            rowData.push($(this).text().trim());
                        }
                    });
                    tableData.push(rowData);
                });

                // Create worksheet and download
                var ws = XLSX.utils.aoa_to_sheet(tableData);
                var wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "University");

                // Export to file
                XLSX.writeFile(wb, "Universitys.xlsx");
            });
        });
    </script>
}
